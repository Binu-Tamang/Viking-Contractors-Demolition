(function($) {
    function bindEvents(handle, resizable, container) {
        handle.on("mousedown.ba-events touchstart.ba-events", function(e) {
            handle.addClass("ba-draggable");
            resizable.addClass("ba-resizable");

            // Get initial positions
            var startX = e.pageX ? e.pageX : e.originalEvent.touches[0].pageX,
                handleWidth = handle.outerWidth(),
                handleOffset = handle.offset().left + handleWidth - startX,
                containerOffset = container.offset().left,
                containerWidth = container.outerWidth();

            var minLeft = containerOffset + 10,
                maxLeft = containerOffset + containerWidth - handleWidth - 10;

            handle.parents().on("mousemove.ba-events touchmove.ba-events", function(e) {
                var moveX = e.pageX ? e.pageX : e.originalEvent.touches[0].pageX;
                var leftValue = moveX + handleOffset - handleWidth;

                if (leftValue < minLeft) leftValue = minLeft;
                if (leftValue > maxLeft) leftValue = maxLeft;

                var widthValue = 100 * (leftValue + handleWidth / 2 - containerOffset) / containerWidth + "%";

                $(".ba-draggable").css("left", widthValue);
                $(".ba-resizable").css("width", widthValue);
            }).on("mouseup.ba-events touchend.ba-events touchcancel.ba-events", function() {
                handle.removeClass("ba-draggable");
                resizable.removeClass("ba-resizable");
                $(this).off(".ba-events");
            });

            e.preventDefault();
        });
    }

    $.fn.beforeAfter = function() {
        var container = this;
        var containerWidth = container.width() + "px";

        container.find(".resize img").css("width", containerWidth);
        bindEvents(container.find(".handle"), container.find(".resize"), container);

        $(window).resize(function() {
            var newWidth = container.width() + "px";
            container.find(".resize img").css("width", newWidth);
        });
    };
})(jQuery);
